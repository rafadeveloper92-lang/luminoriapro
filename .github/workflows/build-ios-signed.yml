name: Build iOS with Code Signing (Optional)

# Este workflow é opcional e só funciona se você configurar os secrets
# de assinatura de código da Apple (certificados e provisioning profiles)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build environment'
        required: true
        type: choice
        options:
          - development
          - adhoc
          - appstore
        default: 'adhoc'

env:
  FLUTTER_VERSION: '3.38.5'

jobs:
  build-ios-signed:
    name: Build iOS with Code Signing
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Install CocoaPods
        run: |
          cd ios
          pod install
          cd ..
      
      # Configurar certificados e provisioning profiles
      - name: Setup iOS Signing
        env:
          P12_CERTIFICATE: ${{ secrets.IOS_P12_CERTIFICATE }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Criar keychain temporário
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Importar certificado
          echo "$P12_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          
          # Instalar provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
      
      - name: Build iOS (Signed)
        run: |
          flutter build ios --release
          mkdir -p dist
          
          # Criar IPA assinado
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../dist/flutteriptv-iOS-${{ github.event.inputs.environment }}.ipa Payload
          cd ../../..
      
      - name: Upload iOS Signed Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-signed-${{ github.event.inputs.environment }}
          path: dist/flutteriptv-iOS-${{ github.event.inputs.environment }}.ipa
          retention-days: 30
      
      # Upload para TestFlight (App Store builds)
      - name: Upload to TestFlight
        if: github.event.inputs.environment == 'appstore'
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file dist/flutteriptv-iOS-appstore.ipa \
            --apiKey "$APP_STORE_CONNECT_API_KEY"
