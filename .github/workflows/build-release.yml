name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # ä»…åœ¨æ¨é€tagæ—¶è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  FLUTTER_VERSION: '3.38.5'

jobs:
  # ============================================
  # Build Windows Application
  # ============================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create .env for build
        run: |
          if (Test-Path .env.example) { Copy-Item .env.example .env } else { Set-Content -Path .env -Value "# placeholder" }
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Windows Release
        run: flutter build windows --release
      
      - name: Download SQLite3 DLL
        run: |
          $urls = @(
            "https://www.sqlite.org/2025/sqlite-dll-win-x64-3510100.zip",
            "https://www.sqlite.org/2024/sqlite-dll-win-x64-3470200.zip"
          )
          foreach ($url in $urls) {
            try {
              Invoke-WebRequest -Uri $url -OutFile "sqlite3.zip" -TimeoutSec 30
              Expand-Archive -Path "sqlite3.zip" -DestinationPath "sqlite3_temp" -Force
              if (Test-Path "sqlite3_temp/sqlite3.dll") {
                Copy-Item "sqlite3_temp/sqlite3.dll" "build/windows/x64/runner/Release/" -Force
                break
              }
            } catch { continue }
          }
        shell: pwsh
      
      - name: Create Installer
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          if (!$version) { $version = "1.0.0" }
          @"
          [Setup]
          AppName=FlutterIPTV
          AppVersion=$version
          AppPublisher=FlutterIPTV
          DefaultDirName={autopf}\FlutterIPTV
          DefaultGroupName=FlutterIPTV
          OutputDir=.
          OutputBaseFilename=flutteriptv-Windows-x64-Setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64
          PrivilegesRequired=lowest
          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          [Icons]
          Name: "{group}\FlutterIPTV"; Filename: "{app}\flutter_iptv.exe"
          Name: "{autodesktop}\FlutterIPTV"; Filename: "{app}\flutter_iptv.exe"; Tasks: desktopicon
          [Tasks]
          Name: "desktopicon"; Description: "Create desktop shortcut"; GroupDescription: "Additional icons:"
          [Run]
          Filename: "{app}\flutter_iptv.exe"; Description: "Launch FlutterIPTV"; Flags: nowait postinstall skipifsilent
          "@ | Out-File "installer.iss" -Encoding UTF8
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        shell: pwsh
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: flutteriptv-Windows-x64-Setup.exe
          retention-days: 5

  # ============================================
  # Build All Android APKs (Mobile + TV)
  # ============================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create .env for build
        run: cp -n .env.example .env 2>/dev/null || true; test -f .env || echo '# placeholder' > .env
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Setup Android Signing
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release-key.jks
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=release-key.jks
          EOF
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Mobile APKs
        run: |
          flutter clean
          flutter build apk --release --split-per-abi
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/flutteriptv-Android-Mobile-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/flutteriptv-Android-Mobile-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/flutteriptv-Android-Mobile-x86_64.apk
      
      - name: Build TV APKs
        run: |
          flutter clean
          flutter build apk --release --dart-define=IS_TV=true --split-per-abi
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/flutteriptv-AndroidTV-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/flutteriptv-AndroidTV-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/flutteriptv-AndroidTV-x86_64.apk
      
      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: dist/
          retention-days: 5

  # ============================================
  # Build iOS Application
  # ============================================
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create .env for build
        run: cp -n .env.example .env 2>/dev/null || true; test -f .env || echo '# placeholder' > .env
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Install CocoaPods
        run: |
          cd ios
          pod install
          cd ..
      
      - name: Build iOS (No Codesign)
        run: |
          flutter build ios --release --no-codesign
          mkdir -p dist
          # Criar arquivo IPA nÃ£o assinado para distribuiÃ§Ã£o de teste
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../dist/flutteriptv-iOS-unsigned.ipa Payload
          cd ../../..
      
      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: dist/flutteriptv-iOS-unsigned.ipa
          retention-days: 5

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    needs: [build-windows, build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-assets/
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "TAG=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "CREATE_RELEASE=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "CREATE_RELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-build" >> $GITHUB_OUTPUT
            echo "TAG=dev-build" >> $GITHUB_OUTPUT
            echo "CREATE_RELEASE=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Release Notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="${{ steps.version.outputs.TAG }}"
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}"
          
          # Read changelog from version.json
          if [ -f "docs/version.json" ]; then
            CHANGELOG_ZH=$(jq -r '.changelog.zh' docs/version.json | sed 's/\\n/\n/g')
            CHANGELOG_EN=$(jq -r '.changelog.en' docs/version.json | sed 's/\\n/\n/g')
          else
            # Fallback to git commits if version.json not found
            PREV_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -v "^${TAG}$" | head -1)
            if [ -n "$PREV_TAG" ]; then
              CHANGELOG_ZH=$(git log --pretty=format:"- %s" ${PREV_TAG}..${TAG} 2>/dev/null | grep -v "^- Merge" || echo "- Bug fixes and improvements")
              CHANGELOG_EN="${CHANGELOG_ZH}"
            else
              CHANGELOG_ZH="- åˆå§‹ç‰ˆæœ¬"
              CHANGELOG_EN="- Initial release"
            fi
          fi
          
          cat > release_notes.md << EOF
          ## ğŸ“º FlutterIPTV ${VERSION}
          
          ### ğŸ“ æ›´æ–°å†…å®¹ What's New
          
          **ä¸­æ–‡ Chinese:**
          ${CHANGELOG_ZH}
          
          **English:**
          ${CHANGELOG_EN}
          
          ---
          
          ### ğŸ“¥ ä¸‹è½½ Downloads
          
          #### ğŸ–¥ï¸ Windows
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | [flutteriptv-Windows-x64-Setup.exe](${BASE_URL}/flutteriptv-Windows-x64-Setup.exe) | Windows 64ä½å®‰è£…åŒ… |
          
          #### ğŸ“± Android æ‰‹æœºç‰ˆ
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | [flutteriptv-Android-Mobile-arm64-v8a.apk](${BASE_URL}/flutteriptv-Android-Mobile-arm64-v8a.apk) | 64ä½ ARM è®¾å¤‡ï¼ˆæ¨èï¼‰ |
          | [flutteriptv-Android-Mobile-armeabi-v7a.apk](${BASE_URL}/flutteriptv-Android-Mobile-armeabi-v7a.apk) | 32ä½ ARM è®¾å¤‡ |
          | [flutteriptv-Android-Mobile-x86_64.apk](${BASE_URL}/flutteriptv-Android-Mobile-x86_64.apk) | x86_64 æ¨¡æ‹Ÿå™¨ |
          
          #### ğŸ“º Android TV ç”µè§†ç‰ˆ
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | [flutteriptv-AndroidTV-arm64-v8a.apk](${BASE_URL}/flutteriptv-AndroidTV-arm64-v8a.apk) | 64ä½ ARM ç”µè§†ï¼ˆæ¨èï¼‰ |
          | [flutteriptv-AndroidTV-armeabi-v7a.apk](${BASE_URL}/flutteriptv-AndroidTV-armeabi-v7a.apk) | 32ä½ ARM ç”µè§† |
          | [flutteriptv-AndroidTV-x86_64.apk](${BASE_URL}/flutteriptv-AndroidTV-x86_64.apk) | x86_64 ç”µè§†æ¨¡æ‹Ÿå™¨ |
          
          #### ğŸ iOS
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | [flutteriptv-iOS-unsigned.ipa](${BASE_URL}/flutteriptv-iOS-unsigned.ipa) | iOS æœªç­¾åç‰ˆæœ¬ï¼ˆéœ€è¦è‡ªç­¾åï¼‰ |
          
          > âš ï¸ **iOS æ³¨æ„äº‹é¡¹**: IPA æ–‡ä»¶æœªç­¾åï¼Œéœ€è¦ä½¿ç”¨å·¥å…·å¦‚ AltStoreã€Sideloadly æˆ– Xcode è¿›è¡Œç­¾åå’Œå®‰è£…ã€‚
          EOF
      
      - name: Create Release
        if: steps.version.outputs.CREATE_RELEASE == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: flutteriptv ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-assets/windows-release/flutteriptv-Windows-x64-Setup.exe
            release-assets/android-release/flutteriptv-Android-Mobile-arm64-v8a.apk
            release-assets/android-release/flutteriptv-Android-Mobile-armeabi-v7a.apk
            release-assets/android-release/flutteriptv-Android-Mobile-x86_64.apk
            release-assets/android-release/flutteriptv-AndroidTV-arm64-v8a.apk
            release-assets/android-release/flutteriptv-AndroidTV-armeabi-v7a.apk
            release-assets/android-release/flutteriptv-AndroidTV-x86_64.apk
            release-assets/ios-release/flutteriptv-iOS-unsigned.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Complete (No Release)
        if: steps.version.outputs.CREATE_RELEASE == 'false'
        run: |
          echo "âœ… Build completed successfully!"
          echo "ğŸ“¦ Artifacts created but no release published (branch push)"
          echo "ğŸ·ï¸ To create a release, push a tag (v1.0.0) or use workflow_dispatch"
