name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Gatilho ao enviar uma tag (ex: v1.4.32)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.4.32)'
        required: true
        default: '1.4.32'

env:
  FLUTTER_VERSION: '3.38.5'

jobs:
  # ============================================
  # Build Windows Application
  # ============================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Prepare build environment
        shell: pwsh
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE_CONTENT }}
        run: |
          if ($env:ENV_FILE_CONTENT) {
            Set-Content -Path .env -Value $env:ENV_FILE_CONTENT
          }
          if (-not (Test-Path .env)) {
            if (Test-Path .env.example) { Copy-Item .env.example .env } else { Set-Content -Path .env -Value '# placeholder' }
          }
          $badges = 'assets/images/badges'
          New-Item -ItemType Directory -Path $badges -Force | Out-Null
          if (-not (Test-Path "$badges/.gitkeep")) { Set-Content -Path "$badges/.gitkeep" -Value '' }
          Test-Path .env
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Windows Release
        run: flutter build windows --release
      
      - name: Download SQLite3 DLL
        run: |
          $url = "https://www.sqlite.org/2025/sqlite-dll-win-x64-3510100.zip"
          try {
            Invoke-WebRequest -Uri $url -OutFile "sqlite3.zip" -TimeoutSec 30
            Expand-Archive -Path "sqlite3.zip" -DestinationPath "sqlite3_temp" -Force
            Copy-Item "sqlite3_temp/sqlite3.dll" "build/windows/x64/runner/Release/" -Force
          } catch { Write-Host "SQLite DLL download failed" }
        shell: pwsh
      
      - name: Create Installer
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          if (!$version) { $version = "1.0.0" }
          @"
          [Setup]
          AppName=FlutterIPTV
          AppVersion=$version
          AppPublisher=FlutterIPTV
          DefaultDirName={autopf}\FlutterIPTV
          DefaultGroupName=FlutterIPTV
          OutputDir=.
          OutputBaseFilename=flutteriptv-Windows-x64-Setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64
          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          [Icons]
          Name: "{group}\FlutterIPTV"; Filename: "{app}\flutter_iptv.exe"
          "@ | Out-File "installer.iss" -Encoding UTF8
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        shell: pwsh
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: flutteriptv-Windows-x64-Setup.exe

  # ============================================
  # Build Android APKs
  # ============================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Prepare build environment
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE_CONTENT }}
        run: |
          [ -n "$ENV_FILE_CONTENT" ] && echo "$ENV_FILE_CONTENT" > .env || echo "# placeholder" > .env
          mkdir -p assets/images/badges
          touch assets/images/badges/.gitkeep
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APKs
        run: |
          flutter build apk --release --split-per-abi
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/flutteriptv-Android-arm64.apk
      
      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: dist/

  # ============================================
  # Build iOS (Unsigned)
  # ============================================
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Prepare build environment
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE_CONTENT }}
        run: |
          [ -n "$ENV_FILE_CONTENT" ] && echo "$ENV_FILE_CONTENT" > .env || echo "# placeholder" > .env
          mkdir -p assets/images/badges
          touch assets/images/badges/.gitkeep
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Install CocoaPods
        run: |
          cd ios
          pod repo update
          pod install
          cd ..
      
      - name: Build iOS (No Codesign)
        run: |
          flutter build ios --release --no-codesign
          mkdir -p dist
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../dist/flutteriptv-iOS-unsigned.ipa Payload
      
      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: dist/flutteriptv-iOS-unsigned.ipa

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    needs: [build-windows, build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-assets/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: Release ${{ github.event.inputs.version || github.ref_name }}
          files: |
            release-assets/windows-release/*.exe
            release-assets/android-release/*.apk
            release-assets/ios-release/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}